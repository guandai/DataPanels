var fs=require("fs"),path=require("path"),gulp=require("gulp"),plugins=require("gulp-load-plugins")(),runSequence=require("run-sequence"),pkg=require("./package.json"),dirs=pkg["h5bp-configs"].directories;gulp.task("archive:create_archive_dir",function(){fs.mkdirSync(path.resolve(dirs.archive),"0755")}),gulp.task("archive:zip",function(done){var archiveName=path.resolve(dirs.archive,pkg.name+"_v"+pkg.version+".zip"),archiver=require("archiver")("zip"),files=require("glob").sync("**/*.*",{cwd:dirs.dist,dot:!0}),output=fs.createWriteStream(archiveName);archiver.on("error",function(error){throw done(),error}),output.on("close",done),files.forEach(function(file){var filePath=path.resolve(dirs.dist,file);archiver.append(fs.createReadStream(filePath),{name:file,mode:fs.statSync(filePath)})}),archiver.pipe(output),archiver.finalize()}),gulp.task("clean",function(done){require("del")([dirs.archive,dirs.dist],done)}),gulp.task("copy",["copy:.htaccess","copy:index.html","copy:jquery","copy:license","copy:main.css","copy:misc","copy:normalize"]),gulp.task("copy:.htaccess",function(){return gulp.src("node_modules/apache-server-configs/dist/.htaccess").pipe(plugins.replace(/# ErrorDocument/g,"ErrorDocument")).pipe(gulp.dest(dirs.dist))}),gulp.task("copy:index.html",function(){return gulp.src(dirs.src+"/index.html").pipe(plugins.replace(/{{JQUERY_VERSION}}/g,pkg.devDependencies.jquery)).pipe(gulp.dest(dirs.dist))}),gulp.task("copy:jquery",function(){return gulp.src(["node_modules/jquery/dist/jquery.min.js"]).pipe(plugins.rename("jquery-"+pkg.devDependencies.jquery+".min.js")).pipe(gulp.dest(dirs.dist+"/js/vendor"))}),gulp.task("copy:license",function(){return gulp.src("LICENSE.txt").pipe(gulp.dest(dirs.dist))}),gulp.task("copy:main.css",function(){var banner="/*! HTML5 Boilerplate v"+pkg.version+" | "+pkg.license.type+" License | "+pkg.homepage+" */\n\n";return gulp.src(dirs.src+"/css/main.css").pipe(plugins.header(banner)).pipe(plugins.autoprefixer({browsers:["last 2 versions","ie >= 8","> 1%"],cascade:!1})).pipe(gulp.dest(dirs.dist+"/css"))}),gulp.task("copy:misc",function(){return gulp.src([dirs.src+"/**/*","!"+dirs.src+"/css/main.css","!"+dirs.src+"/index.html"],{dot:!0}).pipe(gulp.dest(dirs.dist))}),gulp.task("copy:normalize",function(){return gulp.src("node_modules/normalize.css/normalize.css").pipe(gulp.dest(dirs.dist+"/css"))}),gulp.task("lint:js",function(){return gulp.src(["gulpfile.js",dirs.src+"/js/*.js",dirs.test+"/*.js"]).pipe(plugins.jscs()).pipe(plugins.jshint()).pipe(plugins.jshint.reporter("jshint-stylish")).pipe(plugins.jshint.reporter("fail"))}),gulp.task("archive",function(done){runSequence("build","archive:create_archive_dir","archive:zip",done)}),gulp.task("build",function(done){runSequence(["clean","lint:js"],"copy",done)}),gulp.task("default",["build"]);