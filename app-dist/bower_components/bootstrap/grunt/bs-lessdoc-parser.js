/*!
 * Bootstrap Grunt task for parsing Less docstrings
 * http://getbootstrap.com
 * Copyright 2014 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 */

function markdown2html(markdownString){return markdown.toHTML(markdownString.trim()).slice(3,-4)}function Section(heading,customizable){this.heading=heading.trim(),this.id=this.heading.replace(/\s+/g,"-").toLowerCase(),this.customizable=customizable,this.docstring=null,this.subsections=[]}function SubSection(heading){this.heading=heading.trim(),this.id=this.heading.replace(/\s+/g,"-").toLowerCase(),this.variables=[]}function VarDocstring(markdownString){this.html=markdown2html(markdownString)}function SectionDocstring(markdownString){this.html=markdown2html(markdownString)}function Variable(name,defaultValue){this.name=name,this.defaultValue=defaultValue,this.docstring=null}function Tokenizer(fileContent){this._lines=fileContent.split("\n"),this._next=void 0}function Parser(fileContent){this._tokenizer=new Tokenizer(fileContent)}var markdown=require("markdown").markdown,CUSTOMIZABLE_HEADING=/^[/]{2}={2}(.*)$/,UNCUSTOMIZABLE_HEADING=/^[/]{2}-{2}(.*)$/,SUBSECTION_HEADING=/^[/]{2}={3}(.*)$/,SECTION_DOCSTRING=/^[/]{2}#{2}(.*)$/,VAR_ASSIGNMENT=/^(@[a-zA-Z0-9_-]+):[ ]*([^ ;][^;]+);[ ]*$/,VAR_DOCSTRING=/^[/]{2}[*]{2}(.*)$/;Section.prototype.addSubSection=function(subsection){this.subsections.push(subsection)},SubSection.prototype.addVar=function(variable){this.variables.push(variable)},Tokenizer.prototype.unshift=function(token){if(void 0!==this._next)throw new Error("Attempted to unshift twice!");this._next=token},Tokenizer.prototype._shift=function(){if(void 0!==this._next){var result=this._next;return this._next=void 0,result}if(this._lines.length<=0)return null;var line=this._lines.shift(),match=null;if(match=SUBSECTION_HEADING.exec(line),null!==match)return new SubSection(match[1]);if(match=CUSTOMIZABLE_HEADING.exec(line),null!==match)return new Section(match[1],!0);if(match=UNCUSTOMIZABLE_HEADING.exec(line),null!==match)return new Section(match[1],!1);if(match=SECTION_DOCSTRING.exec(line),null!==match)return new SectionDocstring(match[1]);if(match=VAR_DOCSTRING.exec(line),null!==match)return new VarDocstring(match[1]);var commentStart=line.lastIndexOf("//"),varLine=-1===commentStart?line:line.slice(0,commentStart);return match=VAR_ASSIGNMENT.exec(varLine),null!==match?new Variable(match[1],match[2]):void 0},Tokenizer.prototype.shift=function(){for(;;){var result=this._shift();if(void 0!==result)return result}},Parser.prototype.parseFile=function(){for(var sections=[];;){var section=this.parseSection();if(null===section){if(null!==this._tokenizer.shift())throw new Error("Unexpected unparsed section of file remains!");return sections}sections.push(section)}},Parser.prototype.parseSection=function(){var section=this._tokenizer.shift();if(null===section)return null;if(!(section instanceof Section))throw new Error("Expected section heading; got: "+JSON.stringify(section));var docstring=this._tokenizer.shift();return docstring instanceof SectionDocstring?section.docstring=docstring:this._tokenizer.unshift(docstring),this.parseSubSections(section),section},Parser.prototype.parseSubSections=function(section){for(;;){var subsection=this.parseSubSection();if(null===subsection){if(0!==section.subsections.length)break;subsection=new SubSection(""),this.parseVars(subsection)}section.addSubSection(subsection)}1!==section.subsections.length||section.subsections[0].heading||0!==section.subsections[0].variables.length||(section.subsections=[])},Parser.prototype.parseSubSection=function(){var subsection=this._tokenizer.shift();return subsection instanceof SubSection?(this.parseVars(subsection),subsection):(this._tokenizer.unshift(subsection),null)},Parser.prototype.parseVars=function(subsection){for(;;){var variable=this.parseVar();if(null===variable)return;subsection.addVar(variable)}},Parser.prototype.parseVar=function(){var docstring=this._tokenizer.shift();docstring instanceof VarDocstring||(this._tokenizer.unshift(docstring),docstring=null);var variable=this._tokenizer.shift();return variable instanceof Variable?(variable.docstring=docstring,variable):(this._tokenizer.unshift(variable),null)},module.exports=Parser;