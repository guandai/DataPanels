var root=this,smt={},isNode=!1;if("undefined"!=typeof module&&module.exports?(module.exports=smt,root.smt=smt,isNode=!0,console.log("Run Node mode")):(root.smt=smt,console.log("Run browser mode")),isNode)var http=require("http"),winston=require("winston"),util=require("util"),mkpath=require("mkpath"),logger=new winston.Logger({transports:[new winston.transports.Console,new winston.transports.File({filename:"log/serverlog.log"})]});var smtc=smt.tc=function(){console.log(arguments)};smt.creatfolder=function(folderstr){mkpath(folderstr,function(err){return err?(err.toString().indexOf("EEXIST")>=0,!1):void mkpath.sync(folderstr,777)})};var smtr=smt.tr=function(){var allstr="";for(var i in arguments)allstr+=arguments[i]+" ";isNode?logger.log("info",allstr):smtc(allstr)};smt.obj2reg=function(obj){var reg="";for(var o in obj)reg+=obj[o]+"|";return reg=new RegExp(reg.slice(0,-1))},smt.revertjson=function(obj){var newobj={};for(var r in obj)for(var c in obj[r])newobj[c]||(newobj[c]={}),newobj[c][r]=obj[r][c];return newobj},smt.fillzero=function(str,digits){digits||(digits=3),str=str.toString();var pos=str.indexOf(".");-1===pos&&(pos=str.length),str=str.substring(0,pos+digits);var a=smt.cutdec(100*str,0)+"%";return a},smt.replacepeer=function(replace_peer,str){for(var replace_peer_regex=smt.obj2reg(Object.keys(replace_peer).map(function(str){return str.splice(0,"\\").splice(-1,"\\")}));replace_peer_regex.test(str);)for(var r in replace_peer)str=str.replaceAll(r,replace_peer[r]);return str},smt.tru=function(obj,dep,show){tr(util.inspect(obj,{showHidden:show,depth:dep}))},smt.tranHtml2Txt=function(str){return str.replaceall("&amp;","&").replaceall("&quot;",'"').replaceall("&gt;",">").replaceall("&lt;","<").replaceall("&#39;","'").replaceall("&#248;","ø").replaceall("&#229;","å").replaceall("&#230;","æ")},smt.trl=function(){for(var i in arguments)smt.tr(arguments[i])},smt.cutdec=function(str,digits){digits||(digits=2),str=str.toString();var pos=str.indexOf(".");return str=str.substring(0,pos+digits)},smt.shortenunit=function(num){return"number"!=typeof num&&(num=parseInt(num)),num>Math.pow(1024,1)&&num<Math.pow(1024,2)?smt.cutdec(num/Math.pow(1024,1),2).toString()+" KB":num>Math.pow(1024,2)&&num<Math.pow(1024,3)?smt.cutdec(num/Math.pow(1024,2),2).toString()+" MB":num>Math.pow(1024,3)&&num<Math.pow(1024,4)?smt.cutdec(num/Math.pow(1024,3),2).toString()+" GB":num},smt.trmem=function(){var pmem=process.memoryUsage();for(var i in pmem)pmem[i]=smt.shortenunit(pmem[i]);smt.tr("----Memory:",util.inspect(pmem),"------")},smt.osize=function(obj){var count=0;for(var i in obj)i=i,count++;return count},smt.arrainbtest=function(arra,arrb){var testf=!0,sizea=smt.osize(arra),count=0;for(var a in arra)for(var b in arrb)if(arra[a]===arrb[b]){count++;break}return count!==sizea&&(testf=!1),testf},smt.arradiffb=function(arra,arrb){var testaeqb=!1,arrd=[];for(var ia in arra){for(var b in arrb)arra[ia]===arrb[b]&&(testaeqb=!0);testaeqb===!1&&arrd.push(arra[ia])}for(var ib in arrb){for(var abi in arrb)arrb[ib]===arrb[abi]&&(testaeqb=!0);testaeqb===!1&&arrd.push(arrb[ib])}return arrd},smt.arraoverb=function(arra,arrb){var arrbin={};for(var a in arra)for(var b in arrb)arra[a]===arrb[b]&&(arrbin[a]=arra[a]);return arrbin},smt.arragtb=function(arra,arrb){var arrm=[],testeach=!1;for(var a in arra){for(var b in arrb)arra[a]===arrb[b]&&(testeach=!0);testeach===!1&&arrm.push(arra[a])}return arrm},smt.cloneobj=function(obj1){var extend=util._extend,obj2=extend({},obj1);return obj2},smt.clone=function(obj){if(null===obj||"object"!=typeof obj)return obj;var copy=obj.constructor();for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=obj[attr]);return copy},smt.obj2arr=function(obj){var arr=[];for(var o in obj)arr.push(obj[o]);return arr},smt.secondsToString=function(seconds){seconds||(seconds=0);var numhours=Math.floor(seconds%31536e3%86400/3600),numminutes=Math.floor(seconds%31536e3%86400%3600/60),numseconds=Math.floor(seconds%31536e3%86400%3600%60);return numhours+" h "+numminutes+" m "+numseconds+" s"},smt.tobj=function(inobject,varname,end){if("string"==typeof inobject)smt.tr(inobject);else{varname=varname||"noNameObj";var inlength=0;for(var c in inobject)c=c,inlength++;smt.tr("there are "+inlength+" objects in "+varname),end=end||inlength;var count=0;for(var j in inobject)j=j,count++,end>=count&&smt.tr("tobj "+varname+": "+j+": "+inobject[j])}},smt.translatestr=function(str,dictobj){for(var d in dictobj)str=str.replace(d,dictobj[d]);return str},smt.joinAsArray=function(orgarr){var newarr=[];for(var o in orgarr)newarr.push(orgarr[o]);var extarr=[].slice.call(arguments,1);for(var e in extarr)for(var key in extarr[e])newarr.push(extarr[e][key]);return newarr},smt.enmuobj=function(scope,valname,val,docb){for(var i in scope)if(scope[i][valname]===val){docb(scope,i);break}},smt.func2obj=function(infunc){return{cjb:{},opt:{id:0},firstline:infunc.toString().match(/function.*/)[0],funname:infunc.toString().match(/function.*/)[0].match(/\s.*?\s?(?=\()/)[0].match(/\S+/)[0],run:function(){var its=this,lastargs=arguments.length-1,opt=arguments[lastargs];its.startpart(opt.id);var newargs=smt.joinAsArray(arguments,[its.callbacks]);infunc.apply(its,newargs)},callbacks:function(){var its=this,id=arguments[arguments.length-1].fid;if(its.endpart(id),its.callback){"function"==typeof its.callback&&(its.callback=[its.callback]);for(var f in its.callback)"function"!=typeof its.callback[f]?smt.tr("No callback need to run !"):its.callback[f].apply(this,arguments)}},startpart:function(id){smt.tr(">>SSS Start of [",this.funname,"] for task id",id)},endpart:function(id){smt.tr(">>EEE   End of [",this.funname,"] for task id",id,", and start callback...\n")}}},smt.assignErr=function(option,err,callback){return option.err=err,smt.tr(err,err.stack),callback&&callback(option),option},smt.makecb=function(infunc){for(var restargs=[],a=1;a<arguments.length;a++)restargs.push(arguments[a]);var appcb=function(){var newargs=[];for(var arg in arguments)newargs.push(arguments[arg]);newargs=newargs.concat(restargs),infunc.apply(null,newargs)};return appcb},smt.mergeobj=function(orgObj,appendObj){for(var o in appendObj)orgObj[o]=appendObj[o];return orgObj},smt.tolen=function(str,length){return str=str.toString(),str.length<length&&(str="0"+str,smt.tolen(str,length)),str.length>length&&(str=str.substring(1),smt.tolen(str,length)),str},smt.getMaxOfArray=function(numArray){return Math.max.apply(null,numArray)},smt.filldigits=function(str,digits){for(digits||(digits=2),str=str.toString();str.length<digits;)str="0"+str;return str},smt.gettime=function(cut){var ms=new Date,yy=ms.getYear().toString().substring(1),mm=smt.filldigits(ms.getMonth()+1,2),dd=smt.filldigits(ms.getDate(),2),hh=smt.filldigits(ms.getHours(),2),mi=smt.filldigits(ms.getMinutes(),2),ss=smt.filldigits(ms.getSeconds(),2),result=yy+mm+dd+"-"+hh+mi+ss;return cut||(cut=result.length),result.substring(0,cut)},smt.uppath=function(){var workpath=process.cwd();return workpath.substring(0,workpath.lastIndexOf("/"))},String.prototype.replaceall=function(search,tostr){return this.split(search).join(tostr)},String.prototype.splice=function(idx,rem,s){return"string"==typeof rem&&(s=rem,rem=0),this.slice(0,idx)+s+this.slice(idx+Math.abs(rem))},Object.prototype.slice=function(s,e){e||(e=smt.osize(e));var c=0;for(var i in this)(s>c||c>e)&&delete this[i],c++;return this},Object.defineProperty(Object.prototype,"slice",{enumerable:!1}),String.prototype.replaceAll=function(search,tostr){return this.split(search).join(tostr)},smt.getname=function(Object){var funcNameRegex=/smt. = function(.{1,})\(/,results=funcNameRegex.exec(Object.constructor.toString());return results&&results.length>1?results[1]:""},smt.finishfn=function(){smt.tr("Task finished")},smt.trobjmem=function(object){for(var objectList=[],stack=[object],bytes=0;stack.length;){var value=stack.pop();if("boolean"==typeof value)bytes+=4;else if("string"==typeof value)bytes+=2*value.length;else if("number"==typeof value)bytes+=8;else if("object"==typeof value&&-1===objectList.indexOf(value)){objectList.push(value);for(var i in value)stack.push(value[i])}}return smt.tr(smt.shortenunit(parseInt(bytes))),bytes},smt.httpfullbody=function(opt){opt.sentHost=opt.sentHost||"127.0.0.1",opt.sentPort=opt.sentPort||80,opt.sentPath=opt.sentPath||"/",opt.sentMethod=opt.sentMethod||"GET",opt.callback=opt.callback||null,opt.jsonpcallback=opt.jsonpcallback||null,opt.sentQuery=opt.sentQuery||"",smt.tc(opt.callback);var reqopt={hostname:opt.sentHost,port:opt.sentPort,path:opt.sentPath,method:opt.sentMethod},proxyreq=http.request(reqopt,function(proxyres){var returnStatus=proxyres.statusCode,returnHeaders=JSON.stringify(proxyres.headers);smt.tr("STATUS: "+returnStatus),smt.tr("HEADERS: "+returnHeaders),proxyres.setEncoding("utf8");var returnBody="";proxyres.on("data",function(chunk){returnBody+=chunk}),proxyres.on("end",function(){var resBody=returnBody;opt.jsonpcallback&&(resBody=opt.jsonpcallback+"("+resBody+")"),opt.callback(resBody)})});proxyreq.on("error",function(e){smt.tr("problem with request: "+e.message)}),opt.sentQuery&&proxyreq.write(opt.sentQuery),proxyreq.end()},smt.runcbs=function(funcArr){for(var f=1;f<funcArr.length;f++){var setflag=0,funcObj={};funcArr[f]instanceof Array||(funcArr[f]=[funcArr[f]]);for(var r in funcArr[f])"function"==typeof funcArr[f][r].run&&(funcObj=funcArr[f][r],funcArr[f][r]=funcArr[f][r].run,setflag=1);funcArr[f-1].callback=funcArr[f],1===setflag&&(funcArr[f]=funcObj)}},smt.runcbsfn=function(funcArr){for(var funcObjArr=[],f=0;f<funcArr.length-1;f++){var newobj=new smt.func2obj(funcArr[f]);funcObjArr.push(newobj)}return smt.tr(funcObjArr.length),smt.runcbs(funcObjArr),funcObjArr},isNode&&smt.creatfolder("log");