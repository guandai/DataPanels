/*! smt - v0.0.1 - 2015-06-14
* Copyright (c) 2015 twindai; Licensed  */

var root=this,smt={},isNode=!1;if("undefined"!=typeof module&&module.exports?(module.exports=smt,root.smt=smt,isNode=!0,console.log("Run Node mode")):(root.smt=smt,console.log("Run browser mode")),isNode)var http=require("http"),winston=require("winston"),util=require("util"),mkpath=require("mkpath"),logger=new winston.Logger({transports:[new winston.transports.Console,new winston.transports.File({filename:"log/serverlog.log"})]});var smtc=smt.tc=function(){console.log(arguments)};smt.creatfolder=function(a){mkpath(a,function(b){return b?(b.toString().indexOf("EEXIST")>=0,!1):void mkpath.sync(a,777)})};var smtr=smt.tr=function(){var a="";for(var b in arguments)a+=arguments[b]+" ";isNode?logger.log("info",a):smtc(a)};smt.obj2reg=function(a){var b="";for(var c in a)b+=a[c]+"|";return b=new RegExp(b.slice(0,-1))},smt.revertjson=function(a){var b={};for(var c in a)for(var d in a[c])b[d]||(b[d]={}),b[d][c]=a[c][d];return b},smt.fillzero=function(a,b){b||(b=3),a=a.toString();var c=a.indexOf(".");-1===c&&(c=a.length),a=a.substring(0,c+b);var d=smt.cutdec(100*a,0)+"%";return d},smt.replacepeer=function(a,b){for(var c=smt.obj2reg(Object.keys(a).map(function(a){return a.splice(0,"\\").splice(-1,"\\")}));c.test(b);)for(var d in a)b=b.replaceAll(d,a[d]);return b},smt.tru=function(a,b,c){tr(util.inspect(a,{showHidden:c,depth:b}))},smt.tranHtml2Txt=function(a){return a.replaceall("&amp;","&").replaceall("&quot;",'"').replaceall("&gt;",">").replaceall("&lt;","<").replaceall("&#39;","'").replaceall("&#248;","ø").replaceall("&#229;","å").replaceall("&#230;","æ")},smt.trl=function(){for(var a in arguments)smt.tr(arguments[a])},smt.cutdec=function(a,b){b||(b=2),a=a.toString();var c=a.indexOf(".");return a=a.substring(0,c+b)},smt.shortenunit=function(a){return"number"!=typeof a&&(a=parseInt(a)),a>Math.pow(1024,1)&&a<Math.pow(1024,2)?smt.cutdec(a/Math.pow(1024,1),2).toString()+" KB":a>Math.pow(1024,2)&&a<Math.pow(1024,3)?smt.cutdec(a/Math.pow(1024,2),2).toString()+" MB":a>Math.pow(1024,3)&&a<Math.pow(1024,4)?smt.cutdec(a/Math.pow(1024,3),2).toString()+" GB":a},smt.trmem=function(){var a=process.memoryUsage();for(var b in a)a[b]=smt.shortenunit(a[b]);smt.tr("----Memory:",util.inspect(a),"------")},smt.osize=function(a){var b=0;for(var c in a)c=c,b++;return b},smt.arrainbtest=function(a,b){var c=!0,d=smt.osize(a),e=0;for(var f in a)for(var g in b)if(a[f]===b[g]){e++;break}return e!==d&&(c=!1),c},smt.arradiffb=function(a,b){var c=!1,d=[];for(var e in a){for(var f in b)a[e]===b[f]&&(c=!0);c===!1&&d.push(a[e])}for(var g in b){for(var h in b)b[g]===b[h]&&(c=!0);c===!1&&d.push(b[g])}return d},smt.arraoverb=function(a,b){var c={};for(var d in a)for(var e in b)a[d]===b[e]&&(c[d]=a[d]);return c},smt.arragtb=function(a,b){var c=[],d=!1;for(var e in a){for(var f in b)a[e]===b[f]&&(d=!0);d===!1&&c.push(a[e])}return c},smt.cloneobj=function(a){var b=util._extend,c=b({},a);return c},smt.clone=function(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},smt.obj2arr=function(a){var b=[];for(var c in a)b.push(a[c]);return b},smt.secondsToString=function(a){a||(a=0);var b=Math.floor(a%31536e3%86400/3600),c=Math.floor(a%31536e3%86400%3600/60),d=Math.floor(a%31536e3%86400%3600%60);return b+" h "+c+" m "+d+" s"},smt.tobj=function(a,b,c){if("string"==typeof a)smt.tr(a);else{b=b||"noNameObj";var d=0;for(var e in a)e=e,d++;smt.tr("there are "+d+" objects in "+b),c=c||d;var f=0;for(var g in a)g=g,f++,c>=f&&smt.tr("tobj "+b+": "+g+": "+a[g])}},smt.translatestr=function(a,b){for(var c in b)a=a.replace(c,b[c]);return a},smt.joinAsArray=function(a){var b=[];for(var c in a)b.push(a[c]);var d=[].slice.call(arguments,1);for(var e in d)for(var f in d[e])b.push(d[e][f]);return b},smt.enmuobj=function(a,b,c,d){for(var e in a)if(a[e][b]===c){d(a,e);break}},smt.func2obj=function(a){return{cjb:{},opt:{id:0},firstline:a.toString().match(/function.*/)[0],funname:a.toString().match(/function.*/)[0].match(/\s.*?\s?(?=\()/)[0].match(/\S+/)[0],run:function(){var b=this,c=arguments.length-1,d=arguments[c];b.startpart(d.id);var e=smt.joinAsArray(arguments,[b.callbacks]);a.apply(b,e)},callbacks:function(){var a=this,b=arguments[arguments.length-1].fid;if(a.endpart(b),a.callback){"function"==typeof a.callback&&(a.callback=[a.callback]);for(var c in a.callback)"function"!=typeof a.callback[c]?smt.tr("No callback need to run !"):a.callback[c].apply(this,arguments)}},startpart:function(a){smt.tr(">>SSS Start of [",this.funname,"] for task id",a)},endpart:function(a){smt.tr(">>EEE   End of [",this.funname,"] for task id",a,", and start callback...\n")}}},smt.assignErr=function(a,b,c){return a.err=b,smt.tr(b,b.stack),c&&c(a),a},smt.makecb=function(a){for(var b=[],c=1;c<arguments.length;c++)b.push(arguments[c]);var d=function(){var c=[];for(var d in arguments)c.push(arguments[d]);c=c.concat(b),a.apply(null,c)};return d},smt.mergeobj=function(a,b){for(var c in b)a[c]=b[c];return a},smt.tolen=function(a,b){return a=a.toString(),a.length<b&&(a="0"+a,smt.tolen(a,b)),a.length>b&&(a=a.substring(1),smt.tolen(a,b)),a},smt.getMaxOfArray=function(a){return Math.max.apply(null,a)},smt.filldigits=function(a,b){for(b||(b=2),a=a.toString();a.length<b;)a="0"+a;return a},smt.gettime=function(a){var b=new Date,c=b.getYear().toString().substring(1),d=smt.filldigits(b.getMonth()+1,2),e=smt.filldigits(b.getDate(),2),f=smt.filldigits(b.getHours(),2),g=smt.filldigits(b.getMinutes(),2),h=smt.filldigits(b.getSeconds(),2),i=c+d+e+"-"+f+g+h;return a||(a=i.length),i.substring(0,a)},smt.uppath=function(){var a=process.cwd();return a.substring(0,a.lastIndexOf("/"))},String.prototype.replaceall=function(a,b){return this.split(a).join(b)},String.prototype.splice=function(a,b,c){return"string"==typeof b&&(c=b,b=0),this.slice(0,a)+c+this.slice(a+Math.abs(b))},Object.prototype.slice=function(a,b){b||(b=smt.osize(b));var c=0;for(var d in this)(a>c||c>b)&&delete this[d],c++;return this},Object.defineProperty(Object.prototype,"slice",{enumerable:!1}),String.prototype.replaceAll=function(a,b){return this.split(a).join(b)},smt.getname=function(a){var b=/smt. = function(.{1,})\(/,c=b.exec(a.constructor.toString());return c&&c.length>1?c[1]:""},smt.finishfn=function(){smt.tr("Task finished")},smt.trobjmem=function(a){for(var b=[],c=[a],d=0;c.length;){var e=c.pop();if("boolean"==typeof e)d+=4;else if("string"==typeof e)d+=2*e.length;else if("number"==typeof e)d+=8;else if("object"==typeof e&&-1===b.indexOf(e)){b.push(e);for(var f in e)c.push(e[f])}}return smt.tr(smt.shortenunit(parseInt(d))),d},smt.httpfullbody=function(a){a.sentHost=a.sentHost||"127.0.0.1",a.sentPort=a.sentPort||80,a.sentPath=a.sentPath||"/",a.sentMethod=a.sentMethod||"GET",a.callback=a.callback||null,a.jsonpcallback=a.jsonpcallback||null,a.sentQuery=a.sentQuery||"",smt.tc(a.callback);var b={hostname:a.sentHost,port:a.sentPort,path:a.sentPath,method:a.sentMethod},c=http.request(b,function(b){var c=b.statusCode,d=JSON.stringify(b.headers);smt.tr("STATUS: "+c),smt.tr("HEADERS: "+d),b.setEncoding("utf8");var e="";b.on("data",function(a){e+=a}),b.on("end",function(){var b=e;a.jsonpcallback&&(b=a.jsonpcallback+"("+b+")"),a.callback(b)})});c.on("error",function(a){smt.tr("problem with request: "+a.message)}),a.sentQuery&&c.write(a.sentQuery),c.end()},smt.runcbs=function(a){for(var b=1;b<a.length;b++){var c=0,d={};a[b]instanceof Array||(a[b]=[a[b]]);for(var e in a[b])"function"==typeof a[b][e].run&&(d=a[b][e],a[b][e]=a[b][e].run,c=1);a[b-1].callback=a[b],1===c&&(a[b]=d)}},smt.runcbsfn=function(a){for(var b=[],c=0;c<a.length-1;c++){var d=new smt.func2obj(a[c]);b.push(d)}return smt.tr(b.length),smt.runcbs(b),b},isNode&&smt.creatfolder("log");